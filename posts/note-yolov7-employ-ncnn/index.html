<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用 ncnn 将 Yolov7 部署到 Android | YusJade 的个人博客</title>
<meta name=keywords content><meta name=description content="part1: 拉取 Yolov7 仓库并配置适用的虚拟环境
part1-1: 安装 Git 和 MiniConda


    Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。"><meta name=author content><link rel=canonical href=https://yusjade.github.io/posts/note-yolov7-employ-ncnn/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://yusjade.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yusjade.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yusjade.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yusjade.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yusjade.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://yusjade.github.io/posts/note-yolov7-employ-ncnn/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://yusjade.github.io/posts/note-yolov7-employ-ncnn/"><meta property="og:site_name" content="YusJade 的个人博客"><meta property="og:title" content="使用 ncnn 将 Yolov7 部署到 Android"><meta property="og:description" content="part1: 拉取 Yolov7 仓库并配置适用的虚拟环境 part1-1: 安装 Git 和 MiniConda Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-27T12:41:17+08:00"><meta property="article:modified_time" content="2025-01-27T12:41:17+08:00"><meta property="og:image" content="https://yusjade.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yusjade.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="使用 ncnn 将 Yolov7 部署到 Android"><meta name=twitter:description content="part1: 拉取 Yolov7 仓库并配置适用的虚拟环境
part1-1: 安装 Git 和 MiniConda


    Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yusjade.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用 ncnn 将 Yolov7 部署到 Android","item":"https://yusjade.github.io/posts/note-yolov7-employ-ncnn/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 ncnn 将 Yolov7 部署到 Android","name":"使用 ncnn 将 Yolov7 部署到 Android","description":"part1: 拉取 Yolov7 仓库并配置适用的虚拟环境 part1-1: 安装 Git 和 MiniConda Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。\n","keywords":[],"articleBody":"part1: 拉取 Yolov7 仓库并配置适用的虚拟环境 part1-1: 安装 Git 和 MiniConda Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。\n下载地址\u0026官网： Git\nMiniConda 是 Anaconda 的轻量版，用于管理 Python 环境和包。\n下载地址\u0026官网：Distribution/Free Download\npart1-2: 拉取仓库并配置 Python 虚拟环境 使用 git 拉取 Yolov7 的仓库。\ncd \u003c你的代码工作目录\u003e git clone https://github.com/WongKinYiu/yolov7.git cd yolov7 仓库内提供了 requirements.txt ，其列出了项目所依赖的所有第三方库及其版本信息。使用 conda 新建一个 Python 虚拟环境，切换至刚刚创建的环境，接着使用环境中的包管理工具 pip 来安装所需的第三方包。\nconda create --name yolov7 python=3.8 -y conda activate yolov7 pip install -r requirements.txt part2: 跑通项目前的一些准备 part2-0: 了解 Yolov7 仓库的项目结构 part2-0-1 目录结构 . ├── cfg // 模型配置文件 │ ├── baseline // 基础配置文件，定义了不同网络架构的 YAML 文件 │ │ ├── r50-csp.yaml │ │ ├── x50-csp.yaml │ │ ├── yolor-csp-x.yaml │ │ ├── yolor-csp.yaml │ │ ├── yolor-d6.yaml │ │ ├── yolor-e6.yaml │ │ ├── yolor-p6.yaml │ │ ├── yolor-w6.yaml │ │ ├── yolov3-spp.yaml │ │ ├── yolov3.yaml │ │ └── yolov4-csp.yaml │ ├── deploy // 部署配置文件，针对特定的 YOLOv7 变种进行配置 │ │ ├── yolov7-d6.yaml │ │ ├── yolov7-e6e.yaml │ │ ├── yolov7-e6.yaml │ │ ├── yolov7-tiny-silu.yaml │ │ ├── yolov7-tiny.yaml │ │ ├── yolov7-w6.yaml │ │ ├── yolov7x.yaml │ │ └── yolov7.yaml │ └── training // 训练时使用的配置文件 │ ├── yolov7-d6.yaml │ ├── yolov7-e6e.yaml │ ├── yolov7-e6.yaml │ ├── yolov7-tiny.yaml │ ├── yolov7-w6.yaml │ ├── yolov7x.yaml │ └── yolov7.yaml ├── data // 包含了训练和推理时使用的数据配置文件 │ ├── coco.yaml │ ├── hyp.scratch.custom.yaml │ ├── hyp.scratch.p5.yaml │ ├── hyp.scratch.p6.yaml │ └── hyp.scratch.tiny.yaml ├── deploy // 将 YOLOv7 部署为 TensorRT 引擎到 Triton 推理服务器 ├── detect.py // 检测脚本 ├── export.py // 模型导出脚本 ├── figure // 存放着一些预测结果 ├── hubconf.py ├── inference // 推理时使用到的一些资源 ├── LICENSE.md ├── models // 包含 YOLOv7 模型的实现代码 │ ├── common.py │ ├── experimental.py │ └── yolo.py ├── paper // 论文 │ └── yolov7.pdf ├── README.md ├── requirements.txt // 记录项目运行所依赖的第三方包 ├── runs // 存放每次 train/detect 的记录，如训练后的权重、检测结果图、损失图等 │ └── detect │ ├── exp │ └── exp2 ├── scripts // 辅助脚本 │ └── get_coco.sh ├── test.py ├── tools // 包含了一些用于模型比较、可视化、转换等操作的工具脚本 ├── traced_model.pt // 追踪模型 ├── train_aux.py // train_aux.py 包含一些辅助功能或代码 ├── train.py // train.py 是主要的训练脚本 ├── utils // 存放一些工具函数 ├── yolov7.pt └─── yolov7-tiny.pt part3: 把项目跑起来 part3-1: 推理 part3-2: 训练 python train.py --weights yolov7-tiny.pt --data data/\u003c你的数据集配置.yaml\u003e --hyp data/hyp_scratch.tiny.yaml hyp 是 hyperparameters（超参数）的缩写，表示模型训练过程中使用的各种超参数配置。\n训练完成后，可以在 runs/train 中找到对应的 exp 文件夹，里面存放着本次训练产生的各种文件。\n. ├── confusion_matrix.png // 混淆矩阵，用于可视化模型在不同类别上的分类性，显示了模型预测的类别与实际类别之间的关系 ├── events.out.tfevents.1706176268.featurize.23402.0 // TensorBoard 日志文件，用于可视化训练过程中的损失、指标等,可以使用TensorBoard加载该文件进行更详细的分析 ├── F1_curve.png // F1分数曲线，F1是精确率（Precision）和召回率（Recall）的调和平均值 ├── hyp.yaml // 超参数配置文件 ├── opt.yaml // 训练选项配置文件 ├── P_curve.png // 精确率（Precision）曲线，展示了模型在不同置信度阈值下的精确率变化 ├── PR_curve.png // 精确率-召回率曲线（Precision-Recall Curve），用于评估模型在不同阈值下的精确率和召回率的平衡 ├── R_curve.png // 召回率（Recall）曲线，展示了模型在不同置信度阈值下的召回率变化 ├── results.png // 训练结果的汇总图 ├── results.txt // 训练结果的文本文件，记录了每一轮训练的具体指标 ├── test_batch0_labels.jpg // 测试集的真实标签可视化图像 ├── test_batch0_pred.jpg // 测试集的预测结果可视化图像 ├── ... ├── test_batch2_labels.jpg ├── test_batch2_pred.jpg ├── train_batch0.jpg // 训练集的批次可视化图像 ├── ... ├── train_batch9.jpg └── weights ├── best_218.pt ├── ... // 训练过程中不同阶段表现最好的模型权重文件 ├── best_458.pt ├── best.pt // 训练过程中表现最好的模型权重文件 ├── epoch_000.pt ├── ... // 每一轮训练生成的模型权重文件 ├── epoch_999.pt ├── init.pt // 初始化模型权重文件，通常是训练开始前的初始权重 └── last.pt // 最后一轮训练生成的模型权重文件 part4: 部署到 Android —— 使用 ncnn ncnn 是腾讯发布的一个开源的、专为移动设备优化的神经网络推理框架：\nTencent/ncnn ncnn is a high-performance neural network inference framework optimized for the mobile platform part4-0: 使用 export.py 导出非 end2end 的 onnx 模型 需要一个非 end2end 的模型，即去掉模型的 Detect 层，Detect 层的功能在推理程序的后处理部分完成。\npython export.py --weights yolov7-tiny.pt --img-size 640 640 part4-1: 使用 pnnx 转化为 ncnn ncnn 提供了转化工具 pnnx，可以通过 pip 安装：\npip install pnnx 使用教程可见官方文档：Tencent/ncnn: use ncnn with pytorch or onnx\n这里以 yolov7-tiny.pt 为例，使用 pnnx 转化的指令为：\npnnx yolov7-tiny.onnx part4-2: 使用 cpp + NDK 编写推理程序 这部分基于一个 ncnn + yolov7 的 Android 例程：\nxiang-wuu/ncnn-android-yolov7 Android Live Demo inferenece of Yolov7 using ncnn 下面是提取推理结果的代码片段，其实就是实现了 Detect 检测层的功能：\n// app/src/main/jni/yolo.cpp static void generate_proposals(const ncnn::Mat \u0026anchors, int stride, const ncnn::Mat \u0026in_pad, const ncnn::Mat \u0026feat_blob, float prob_threshold, std::vector\u003cObject\u003e \u0026objects) { const int num_grid_x = feat_blob.w; const int num_grid_y = feat_blob.h; const int num_anchors = anchors.w / 2; const int num_class = feat_blob.c / num_anchors - 5; const int feat_offset = num_class + 5; // 遍历各个锚框，一般每个尺寸的特征图对应三个锚框 for (int q = 0; q \u003c num_anchors; q++) { const float anchor_w = anchors[q * 2]; const float anchor_h = anchors[q * 2 + 1]; // 解析特征图得到推理结果，这部分代码可以参考 yolov7 的 Detect 层代码实现 for (int i = 0; i \u003c num_grid_y; i++) { for (int j = 0; j \u003c num_grid_x; j++) { // 寻找 score 最大的 class，这部分不属于 Detect 层 int class_index = 0; float class_score = -FLT_MAX; for (int k = 0; k \u003c num_class; k++) { float score = feat_blob.channel(q * feat_offset + 5 + k).row(i)[j]; if (score \u003e class_score) { class_index = k; class_score = score; } } float box_score = feat_blob.channel(q * feat_offset + 4).row(i)[j]; float confidence = sigmoid(box_score) * sigmoid(class_score); if (confidence \u003e= prob_threshold) { // 参考 yolov7/models/yolo.py Detect forward // y = x[i].sigmoid() // y[..., 0:2] = (y[..., 0:2] * 2. - 0.5 + self.grid[i].to(x[i].device)) * self.stride[i] # xy // y[..., 2:4] = (y[..., 2:4] * 2) ** 2 * self.anchor_grid[i] # wh float dx = sigmoid(feat_blob.channel(q * feat_offset + 0).row(i)[j]); float dy = sigmoid(feat_blob.channel(q * feat_offset + 1).row(i)[j]); float dw = sigmoid(feat_blob.channel(q * feat_offset + 2).row(i)[j]); float dh = sigmoid(feat_blob.channel(q * feat_offset + 3).row(i)[j]); float pb_cx = (dx * 2.f - 0.5f + j) * stride; float pb_cy = (dy * 2.f - 0.5f + i) * stride; float pb_w = pow(dw * 2.f, 2) * anchor_w; float pb_h = pow(dh * 2.f, 2) * anchor_h; float x0 = pb_cx - pb_w * 0.5f; float y0 = pb_cy - pb_h * 0.5f; float x1 = pb_cx + pb_w * 0.5f; float y1 = pb_cy + pb_h * 0.5f; Object obj; obj.rect.x = x0; obj.rect.y = y0; obj.rect.width = x1 - x0; obj.rect.height = y1 - y0; obj.label = class_index; obj.prob = confidence; objects.push_back(obj); } } } } } 从模型中提取三种尺寸的特征图输出，经过后处理后得到推理结果：\nint Yolo::detect(const cv::Mat \u0026rgb, std::vector\u003cObject\u003e \u0026objects, float prob_threshold, float nms_threshold) { int img_w = rgb.cols; int img_h = rgb.rows; // letterbox pad to multiple of 32 int w = img_w; int h = img_h; float scale = 1.f; if (w \u003e h) { scale = (float) target_size / w; w = target_size; h = h * scale; } else { scale = (float) target_size / h; h = target_size; w = w * scale; } const int max_stride = 64; ncnn::Mat in = ncnn::Mat::from_pixels_resize(rgb.data, ncnn::Mat::PIXEL_RGB, img_w, img_h, w, h); // pad to target_size rectangle int wpad = (w + max_stride - 1) / max_stride * max_stride - w; int hpad = (h + max_stride - 1) / max_stride * max_stride - h; ncnn::Mat in_pad; ncnn::copy_make_border(in, in_pad, hpad / 2, hpad - hpad / 2, wpad / 2, wpad - wpad / 2, ncnn::BORDER_CONSTANT, 114.f); in_pad.substract_mean_normalize(0, norm_vals); ncnn::Extractor ex = yolo.create_extractor(); ex.input(\"in0\", in_pad); std::vector\u003cObject\u003e proposals; // stride 8 { ncnn::Mat out; ex.extract(\"out0\", out); ncnn::Mat anchors(6); anchors[0] = 12.f; anchors[1] = 16.f; anchors[2] = 19.f; anchors[3] = 36.f; anchors[4] = 40.f; anchors[5] = 28.f; std::vector\u003cObject\u003e objects8; generate_proposals(anchors, 8, in_pad, out, prob_threshold, objects8); proposals.insert(proposals.end(), objects8.begin(), objects8.end()); } // stride 16 { ncnn::Mat out; ex.extract(\"out1\", out); ncnn::Mat anchors(6); anchors[0] = 36.f; anchors[1] = 75.f; anchors[2] = 76.f; anchors[3] = 55.f; anchors[4] = 72.f; anchors[5] = 146.f; std::vector\u003cObject\u003e objects16; generate_proposals(anchors, 16, in_pad, out, prob_threshold, objects16); proposals.insert(proposals.end(), objects16.begin(), objects16.end()); } // stride 32 { ncnn::Mat out; ex.extract(\"out2\", out); ncnn::Mat anchors(6); anchors[0] = 142.f; anchors[1] = 110.f; anchors[2] = 192.f; anchors[3] = 243.f; anchors[4] = 459.f; anchors[5] = 401.f; std::vector\u003cObject\u003e objects32; generate_proposals(anchors, 32, in_pad, out, prob_threshold, objects32); proposals.insert(proposals.end(), objects32.begin(), objects32.end()); } // sort all proposals by score from highest to lowest qsort_descent_inplace(proposals); // apply nms with nms_threshold std::vector\u003cint\u003e picked; nms_sorted_bboxes(proposals, picked, nms_threshold); int count = picked.size(); objects.resize(count); for (int i = 0; i \u003c count; i++) { objects[i] = proposals[picked[i]]; // adjust offset to original unpadded float x0 = (objects[i].rect.x - (wpad / 2)) / scale; float y0 = (objects[i].rect.y - (hpad / 2)) / scale; float x1 = (objects[i].rect.x + objects[i].rect.width - (wpad / 2)) / scale; float y1 = (objects[i].rect.y + objects[i].rect.height - (hpad / 2)) / scale; // clip x0 = std::max(std::min(x0, (float) (img_w - 1)), 0.f); y0 = std::max(std::min(y0, (float) (img_h - 1)), 0.f); x1 = std::max(std::min(x1, (float) (img_w - 1)), 0.f); y1 = std::max(std::min(y1, (float) (img_h - 1)), 0.f); objects[i].rect.x = x0; objects[i].rect.y = y0; objects[i].rect.width = x1 - x0; objects[i].rect.height = y1 - y0; } return 0; } part4-2-1: 匹配模型输出端 extract 的第一个入参要注意与实际模型的输出端名称匹配。\nex.extract(\"out0\", out); 可以以文本方式打开使用 pnnx 转换后得到的 yolov7_tiny.pnnx.param，查看输出端的名称。\n# Op # Name # Attr pnnx.Output out0 1 0 135 #135=(1,3,80,80,85)f32 pnnx.Output out1 1 0 138 #138=(1,3,40,40,85)f32 pnnx.Output out2 1 0 141 #141=(1,3,20,20,85)f32 part4-3: 加载 .param 和 .bin ncnn 模型文件分为网络结构文件.param和权重参数.bin，放到工程目录下的 app/src/main /assets 中，加载代码部分在 app/src/main/jni/yolo.cpp 的 Yolo::load 函数。\n","wordCount":"2844","inLanguage":"zh","image":"https://yusjade.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-01-27T12:41:17+08:00","dateModified":"2025-01-27T12:41:17+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://yusjade.github.io/posts/note-yolov7-employ-ncnn/"},"publisher":{"@type":"Organization","name":"YusJade 的个人博客","logo":{"@type":"ImageObject","url":"https://yusjade.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yusjade.github.io/ accesskey=h title="主页 (Alt + H)">主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yusjade.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://yusjade.github.io/friends/ title=友链><span>友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yusjade.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://yusjade.github.io/posts/>文章</a></div><h1 class=post-title>使用 ncnn 将 Yolov7 部署到 Android</h1><div class=post-meta><span title='2025-01-27 12:41:17 +0800 CST'>2025 年 1 月 27 日</span>&nbsp;·&nbsp;2844 字<div class=meta-item>&nbsp·&nbsp
                <a href=https://yusjade.github.io/categories/%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2/>模型部署</a>
<span>,</span>
<a href=https://yusjade.github.io/categories/ncnn/>Ncnn</a>
<span>,</span>
<a href=https://yusjade.github.io/categories/yolo/>Yolo</a></div></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#part1-%e6%8b%89%e5%8f%96-yolov7-%e4%bb%93%e5%ba%93%e5%b9%b6%e9%85%8d%e7%bd%ae%e9%80%82%e7%94%a8%e7%9a%84%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83 aria-label="part1: 拉取 Yolov7 仓库并配置适用的虚拟环境">part1: 拉取 Yolov7 仓库并配置适用的虚拟环境</a><ul><li><a href=#part1-1-%e5%ae%89%e8%a3%85-git-%e5%92%8c-miniconda aria-label="part1-1: 安装 Git 和 MiniConda">part1-1: 安装 Git 和 MiniConda</a></li><li><a href=#part1-2-%e6%8b%89%e5%8f%96%e4%bb%93%e5%ba%93%e5%b9%b6%e9%85%8d%e7%bd%ae-python-%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83 aria-label="part1-2: 拉取仓库并配置 Python 虚拟环境">part1-2: 拉取仓库并配置 Python 虚拟环境</a></li></ul></li><li><a href=#part2-%e8%b7%91%e9%80%9a%e9%a1%b9%e7%9b%ae%e5%89%8d%e7%9a%84%e4%b8%80%e4%ba%9b%e5%87%86%e5%a4%87 aria-label="part2: 跑通项目前的一些准备">part2: 跑通项目前的一些准备</a><ul><li><a href=#part2-0-%e4%ba%86%e8%a7%a3-yolov7-%e4%bb%93%e5%ba%93%e7%9a%84%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 aria-label="part2-0: 了解 Yolov7 仓库的项目结构">part2-0: 了解 Yolov7 仓库的项目结构</a><ul><li><a href=#part2-0-1-%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label="part2-0-1 目录结构">part2-0-1 目录结构</a></li></ul></li></ul></li><li><a href=#part3-%e6%8a%8a%e9%a1%b9%e7%9b%ae%e8%b7%91%e8%b5%b7%e6%9d%a5 aria-label="part3: 把项目跑起来">part3: 把项目跑起来</a><ul><li><a href=#part3-1-%e6%8e%a8%e7%90%86 aria-label="part3-1: 推理">part3-1: 推理</a></li><li><a href=#part3-2-%e8%ae%ad%e7%bb%83 aria-label="part3-2: 训练">part3-2: 训练</a></li></ul></li><li><a href=#part4-%e9%83%a8%e7%bd%b2%e5%88%b0-android--%e4%bd%bf%e7%94%a8-ncnn aria-label="part4: 部署到 Android —— 使用 ncnn">part4: 部署到 Android —— 使用 ncnn</a><ul><li><a href=#part4-0-%e4%bd%bf%e7%94%a8-exportpy-%e5%af%bc%e5%87%ba%e9%9d%9e-end2end-%e7%9a%84-onnx-%e6%a8%a1%e5%9e%8b aria-label="part4-0: 使用 export.py 导出非 end2end 的 onnx 模型">part4-0: 使用 export.py 导出非 end2end 的 onnx 模型</a></li><li><a href=#part4-1-%e4%bd%bf%e7%94%a8-pnnx-%e8%bd%ac%e5%8c%96%e4%b8%ba-ncnn aria-label="part4-1: 使用 pnnx 转化为 ncnn">part4-1: 使用 pnnx 转化为 ncnn</a></li><li><a href=#part4-2-%e4%bd%bf%e7%94%a8-cpp--ndk-%e7%bc%96%e5%86%99%e6%8e%a8%e7%90%86%e7%a8%8b%e5%ba%8f aria-label="part4-2: 使用 cpp + NDK 编写推理程序">part4-2: 使用 cpp + NDK 编写推理程序</a><ul><li><a href=#part4-2-1-%e5%8c%b9%e9%85%8d%e6%a8%a1%e5%9e%8b%e8%be%93%e5%87%ba%e7%ab%af aria-label="part4-2-1: 匹配模型输出端">part4-2-1: 匹配模型输出端</a></li></ul></li><li><a href=#part4-3-%e5%8a%a0%e8%bd%bd-param-%e5%92%8c-bin aria-label="part4-3: 加载 .param 和 .bin">part4-3: 加载 .param 和 .bin</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=part1-拉取-yolov7-仓库并配置适用的虚拟环境>part1: 拉取 Yolov7 仓库并配置适用的虚拟环境<a hidden class=anchor aria-hidden=true href=#part1-拉取-yolov7-仓库并配置适用的虚拟环境>#</a></h2><h3 id=part1-1-安装-git-和-miniconda>part1-1: 安装 Git 和 MiniConda<a hidden class=anchor aria-hidden=true href=#part1-1-安装-git-和-miniconda>#</a></h3><div class="notice notice-info"><div class=notice-title><svg class="icon notice-icon" viewBox="0 0 512 512"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p>Git 是一个分布式版本控制系统，主要用于跟踪代码变更、协作开发和版本管理。</p></div><p>下载地址&官网： <a href=https://git-scm.com/>Git</a></p><div class="notice notice-info"><div class=notice-title><svg class="icon notice-icon" viewBox="0 0 512 512"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p>MiniConda 是 Anaconda 的轻量版，用于管理 Python 环境和包。</p></div><p>下载地址&官网：<a href=https://www.anaconda.com/download/>Distribution/Free Download</a></p><h3 id=part1-2-拉取仓库并配置-python-虚拟环境>part1-2: 拉取仓库并配置 Python 虚拟环境<a hidden class=anchor aria-hidden=true href=#part1-2-拉取仓库并配置-python-虚拟环境>#</a></h3><p>使用 git 拉取 Yolov7 的仓库。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> &lt;你的代码工作目录&gt;
</span></span><span class=line><span class=cl>git clone https://github.com/WongKinYiu/yolov7.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> yolov7
</span></span></code></pre></div><p>仓库内提供了 requirements.txt ，其列出了项目所依赖的所有第三方库及其版本信息。使用 conda 新建一个 Python 虚拟环境，切换至刚刚创建的环境，接着使用环境中的包管理工具 pip 来安装所需的第三方包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>conda create --name yolov7 <span class=nv>python</span><span class=o>=</span>3.8 -y
</span></span><span class=line><span class=cl>conda activate yolov7 
</span></span><span class=line><span class=cl>pip install -r requirements.txt
</span></span></code></pre></div><h2 id=part2-跑通项目前的一些准备>part2: 跑通项目前的一些准备<a hidden class=anchor aria-hidden=true href=#part2-跑通项目前的一些准备>#</a></h2><h3 id=part2-0-了解-yolov7-仓库的项目结构>part2-0: 了解 Yolov7 仓库的项目结构<a hidden class=anchor aria-hidden=true href=#part2-0-了解-yolov7-仓库的项目结构>#</a></h3><h4 id=part2-0-1-目录结构>part2-0-1 目录结构<a hidden class=anchor aria-hidden=true href=#part2-0-1-目录结构>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── cfg // 模型配置文件
</span></span><span class=line><span class=cl>│   ├── baseline // 基础配置文件，定义了不同网络架构的 YAML 文件
</span></span><span class=line><span class=cl>│   │   ├── r50-csp.yaml
</span></span><span class=line><span class=cl>│   │   ├── x50-csp.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-csp-x.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-csp.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-d6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-e6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-p6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolor-w6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov3-spp.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov3.yaml
</span></span><span class=line><span class=cl>│   │   └── yolov4-csp.yaml
</span></span><span class=line><span class=cl>│   ├── deploy // 部署配置文件，针对特定的 YOLOv7 变种进行配置
</span></span><span class=line><span class=cl>│   │   ├── yolov7-d6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7-e6e.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7-e6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7-tiny-silu.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7-tiny.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7-w6.yaml
</span></span><span class=line><span class=cl>│   │   ├── yolov7x.yaml
</span></span><span class=line><span class=cl>│   │   └── yolov7.yaml
</span></span><span class=line><span class=cl>│   └── training // 训练时使用的配置文件
</span></span><span class=line><span class=cl>│       ├── yolov7-d6.yaml
</span></span><span class=line><span class=cl>│       ├── yolov7-e6e.yaml
</span></span><span class=line><span class=cl>│       ├── yolov7-e6.yaml
</span></span><span class=line><span class=cl>│       ├── yolov7-tiny.yaml
</span></span><span class=line><span class=cl>│       ├── yolov7-w6.yaml
</span></span><span class=line><span class=cl>│       ├── yolov7x.yaml
</span></span><span class=line><span class=cl>│       └── yolov7.yaml
</span></span><span class=line><span class=cl>├── data // 包含了训练和推理时使用的数据配置文件
</span></span><span class=line><span class=cl>│   ├── coco.yaml
</span></span><span class=line><span class=cl>│   ├── hyp.scratch.custom.yaml
</span></span><span class=line><span class=cl>│   ├── hyp.scratch.p5.yaml
</span></span><span class=line><span class=cl>│   ├── hyp.scratch.p6.yaml
</span></span><span class=line><span class=cl>│   └── hyp.scratch.tiny.yaml
</span></span><span class=line><span class=cl>├── deploy // 将 YOLOv7 部署为 TensorRT 引擎到 Triton 推理服务器
</span></span><span class=line><span class=cl>├── detect.py // 检测脚本
</span></span><span class=line><span class=cl>├── export.py // 模型导出脚本
</span></span><span class=line><span class=cl>├── figure // 存放着一些预测结果
</span></span><span class=line><span class=cl>├── hubconf.py
</span></span><span class=line><span class=cl>├── inference // 推理时使用到的一些资源
</span></span><span class=line><span class=cl>├── LICENSE.md
</span></span><span class=line><span class=cl>├── models // 包含 YOLOv7 模型的实现代码
</span></span><span class=line><span class=cl>│   ├── common.py
</span></span><span class=line><span class=cl>│   ├── experimental.py
</span></span><span class=line><span class=cl>│   └── yolo.py
</span></span><span class=line><span class=cl>├── paper // 论文
</span></span><span class=line><span class=cl>│   └── yolov7.pdf
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── requirements.txt // 记录项目运行所依赖的第三方包
</span></span><span class=line><span class=cl>├── runs // 存放每次 train/detect 的记录，如训练后的权重、检测结果图、损失图等
</span></span><span class=line><span class=cl>│   └── detect
</span></span><span class=line><span class=cl>│       ├── exp
</span></span><span class=line><span class=cl>│       └── exp2
</span></span><span class=line><span class=cl>├── scripts // 辅助脚本
</span></span><span class=line><span class=cl>│   └── get_coco.sh
</span></span><span class=line><span class=cl>├── test.py
</span></span><span class=line><span class=cl>├── tools // 包含了一些用于模型比较、可视化、转换等操作的工具脚本
</span></span><span class=line><span class=cl>├── traced_model.pt // 追踪模型
</span></span><span class=line><span class=cl>├── train_aux.py // train_aux.py 包含一些辅助功能或代码
</span></span><span class=line><span class=cl>├── train.py // train.py 是主要的训练脚本
</span></span><span class=line><span class=cl>├── utils // 存放一些工具函数
</span></span><span class=line><span class=cl>├── yolov7.pt
</span></span><span class=line><span class=cl>└─── yolov7-tiny.pt
</span></span></code></pre></div><h2 id=part3-把项目跑起来>part3: 把项目跑起来<a hidden class=anchor aria-hidden=true href=#part3-把项目跑起来>#</a></h2><h3 id=part3-1-推理>part3-1: 推理<a hidden class=anchor aria-hidden=true href=#part3-1-推理>#</a></h3><h3 id=part3-2-训练>part3-2: 训练<a hidden class=anchor aria-hidden=true href=#part3-2-训练>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python train.py --weights yolov7-tiny.pt --data data/&lt;你的数据集配置.yaml&gt; --hyp data/hyp_scratch.tiny.yaml
</span></span></code></pre></div><div class="notice notice-info"><div class=notice-title><svg class="icon notice-icon" viewBox="0 0 512 512"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p>hyp 是 hyperparameters（超参数）的缩写，表示模型训练过程中使用的各种超参数配置。</p></div><p>训练完成后，可以在 <code>runs/train</code> 中找到对应的 <code>exp&lt;n></code> 文件夹，里面存放着本次训练产生的各种文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── confusion_matrix.png // 混淆矩阵，用于可视化模型在不同类别上的分类性，显示了模型预测的类别与实际类别之间的关系
</span></span><span class=line><span class=cl>├── events.out.tfevents.1706176268.featurize.23402.0 // TensorBoard 日志文件，用于可视化训练过程中的损失、指标等,可以使用TensorBoard加载该文件进行更详细的分析
</span></span><span class=line><span class=cl>├── F1_curve.png // F1分数曲线，F1是精确率（Precision）和召回率（Recall）的调和平均值
</span></span><span class=line><span class=cl>├── hyp.yaml  // 超参数配置文件
</span></span><span class=line><span class=cl>├── opt.yaml  // 训练选项配置文件
</span></span><span class=line><span class=cl>├── P_curve.png // 精确率（Precision）曲线，展示了模型在不同置信度阈值下的精确率变化
</span></span><span class=line><span class=cl>├── PR_curve.png // 精确率-召回率曲线（Precision-Recall Curve），用于评估模型在不同阈值下的精确率和召回率的平衡
</span></span><span class=line><span class=cl>├── R_curve.png // 召回率（Recall）曲线，展示了模型在不同置信度阈值下的召回率变化
</span></span><span class=line><span class=cl>├── results.png // 训练结果的汇总图
</span></span><span class=line><span class=cl>├── results.txt // 训练结果的文本文件，记录了每一轮训练的具体指标
</span></span><span class=line><span class=cl>├── test_batch0_labels.jpg // 测试集的真实标签可视化图像
</span></span><span class=line><span class=cl>├── test_batch0_pred.jpg // 测试集的预测结果可视化图像
</span></span><span class=line><span class=cl>├── ...
</span></span><span class=line><span class=cl>├── test_batch2_labels.jpg
</span></span><span class=line><span class=cl>├── test_batch2_pred.jpg
</span></span><span class=line><span class=cl>├── train_batch0.jpg // 训练集的批次可视化图像
</span></span><span class=line><span class=cl>├── ...
</span></span><span class=line><span class=cl>├── train_batch9.jpg
</span></span><span class=line><span class=cl>└── weights
</span></span><span class=line><span class=cl>    ├── best_218.pt
</span></span><span class=line><span class=cl>    ├── ...        // 训练过程中不同阶段表现最好的模型权重文件
</span></span><span class=line><span class=cl>    ├── best_458.pt
</span></span><span class=line><span class=cl>    ├── best.pt // 训练过程中表现最好的模型权重文件
</span></span><span class=line><span class=cl>    ├── epoch_000.pt
</span></span><span class=line><span class=cl>    ├── ...     // 每一轮训练生成的模型权重文件
</span></span><span class=line><span class=cl>    ├── epoch_999.pt
</span></span><span class=line><span class=cl>    ├── init.pt // 初始化模型权重文件，通常是训练开始前的初始权重
</span></span><span class=line><span class=cl>    └── last.pt // 最后一轮训练生成的模型权重文件
</span></span></code></pre></div><h2 id=part4-部署到-android--使用-ncnn>part4: 部署到 Android —— 使用 ncnn<a hidden class=anchor aria-hidden=true href=#part4-部署到-android--使用-ncnn>#</a></h2><p>ncnn 是腾讯发布的一个开源的、专为移动设备优化的神经网络推理框架：</p><div class=github><div class=github_bar><svg width="50" height="50" viewBox="0 0 50 50"><path d="M17.791 46.836C18.502 46.53 19 45.823 19 45v-5.4c0-.197.016-.402.041-.61C19.027 38.994 19.014 38.997 19 39c0 0-3 0-3.6.0-1.5.0-2.8-.6-3.4-1.8-.7-1.3-1-3.5-2.8-4.7C8.9 32.3 9.1 32 9.7 32c.6.1 1.9.9 2.7 2 .9 1.1 1.8 2 3.4 2 2.487.0 3.82-.125 4.622-.555C21.356 34.056 22.649 33 24 33v-.025c-5.668-.182-9.289-2.066-10.975-4.975-3.665.042-6.856.405-8.677.707-.058-.327-.108-.656-.151-.987 1.797-.296 4.843-.647 8.345-.714-.112-.276-.209-.559-.291-.849-3.511-.178-6.541-.039-8.187.097-.02-.332-.047-.663-.051-.999 1.649-.135 4.597-.27 8.018-.111-.079-.5-.13-1.011-.13-1.543.0-1.7.6-3.5 1.7-5-.5-1.7-1.2-5.3.2-6.6 2.7.0 4.6 1.3 5.5 2.1C21 13.4 22.9 13 25 13s4 .4 5.6 1.1c.9-.8 2.8-2.1 5.5-2.1 1.5 1.4.7 5 .2 6.6 1.1 1.5 1.7 3.2 1.6 5 0 .484-.045.951-.11 1.409 3.499-.172 6.527-.034 8.204.102-.002.337-.033.666-.051.999-1.671-.138-4.775-.28-8.359-.089-.089.336-.197.663-.325.98 3.546.046 6.665.389 8.548.689-.043.332-.093.661-.151.987-1.912-.306-5.171-.664-8.879-.682-1.665 2.878-5.22 4.755-10.777 4.974V33c2.6.0 5 3.9 5 6.6V45c0 .823.498 1.53 1.209 1.836C41.37 43.804 48 35.164 48 25 48 12.318 37.683 2 25 2S2 12.318 2 25C2 35.164 8.63 43.804 17.791 46.836z"/></svg>
<a class=github_name href=https://github.com/Tencent/ncnn target=_blank>Tencent/ncnn</a></div><div class=github_description>ncnn is a high-performance neural network inference framework optimized for the mobile platform</div><div class=github_language></div></div><h3 id=part4-0-使用-exportpy-导出非-end2end-的-onnx-模型>part4-0: 使用 export.py 导出非 end2end 的 onnx 模型<a hidden class=anchor aria-hidden=true href=#part4-0-使用-exportpy-导出非-end2end-的-onnx-模型>#</a></h3><p>需要一个非 end2end 的模型，即<strong>去掉模型的 Detect 层</strong>，Detect 层的功能在推理程序的后处理部分完成。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python export.py --weights yolov7-tiny.pt --img-size <span class=m>640</span> <span class=m>640</span>
</span></span></code></pre></div><h3 id=part4-1-使用-pnnx-转化为-ncnn>part4-1: 使用 pnnx 转化为 ncnn<a hidden class=anchor aria-hidden=true href=#part4-1-使用-pnnx-转化为-ncnn>#</a></h3><p>ncnn 提供了转化工具 pnnx，可以通过 pip 安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pip install pnnx
</span></span></code></pre></div><p>使用教程可见官方文档：<a href=https://github.com/Tencent/ncnn/wiki/use-ncnn-with-pytorch-or-onnx>Tencent/ncnn: use ncnn with pytorch or onnx</a></p><p>这里以 yolov7-tiny.pt 为例，使用 pnnx 转化的指令为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pnnx yolov7-tiny.onnx
</span></span></code></pre></div><h3 id=part4-2-使用-cpp--ndk-编写推理程序>part4-2: 使用 cpp + NDK 编写推理程序<a hidden class=anchor aria-hidden=true href=#part4-2-使用-cpp--ndk-编写推理程序>#</a></h3><p>这部分基于一个 ncnn + yolov7 的 Android 例程：</p><div class=github><div class=github_bar><svg width="50" height="50" viewBox="0 0 50 50"><path d="M17.791 46.836C18.502 46.53 19 45.823 19 45v-5.4c0-.197.016-.402.041-.61C19.027 38.994 19.014 38.997 19 39c0 0-3 0-3.6.0-1.5.0-2.8-.6-3.4-1.8-.7-1.3-1-3.5-2.8-4.7C8.9 32.3 9.1 32 9.7 32c.6.1 1.9.9 2.7 2 .9 1.1 1.8 2 3.4 2 2.487.0 3.82-.125 4.622-.555C21.356 34.056 22.649 33 24 33v-.025c-5.668-.182-9.289-2.066-10.975-4.975-3.665.042-6.856.405-8.677.707-.058-.327-.108-.656-.151-.987 1.797-.296 4.843-.647 8.345-.714-.112-.276-.209-.559-.291-.849-3.511-.178-6.541-.039-8.187.097-.02-.332-.047-.663-.051-.999 1.649-.135 4.597-.27 8.018-.111-.079-.5-.13-1.011-.13-1.543.0-1.7.6-3.5 1.7-5-.5-1.7-1.2-5.3.2-6.6 2.7.0 4.6 1.3 5.5 2.1C21 13.4 22.9 13 25 13s4 .4 5.6 1.1c.9-.8 2.8-2.1 5.5-2.1 1.5 1.4.7 5 .2 6.6 1.1 1.5 1.7 3.2 1.6 5 0 .484-.045.951-.11 1.409 3.499-.172 6.527-.034 8.204.102-.002.337-.033.666-.051.999-1.671-.138-4.775-.28-8.359-.089-.089.336-.197.663-.325.98 3.546.046 6.665.389 8.548.689-.043.332-.093.661-.151.987-1.912-.306-5.171-.664-8.879-.682-1.665 2.878-5.22 4.755-10.777 4.974V33c2.6.0 5 3.9 5 6.6V45c0 .823.498 1.53 1.209 1.836C41.37 43.804 48 35.164 48 25 48 12.318 37.683 2 25 2S2 12.318 2 25C2 35.164 8.63 43.804 17.791 46.836z"/></svg>
<a class=github_name href=https://github.com/xiang-wuu/ncnn-android-yolov7 target=_blank>xiang-wuu/ncnn-android-yolov7</a></div><div class=github_description>Android Live Demo inferenece of Yolov7 using ncnn</div><div class=github_language></div></div><p>下面是提取推理结果的代码片段，其实就是实现了 Detect 检测层的功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// app/src/main/jni/yolo.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>generate_proposals</span><span class=p>(</span><span class=k>const</span> <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=o>&amp;</span><span class=n>anchors</span><span class=p>,</span> <span class=kt>int</span> <span class=n>stride</span><span class=p>,</span> <span class=k>const</span> <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=o>&amp;</span><span class=n>in_pad</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=k>const</span> <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=o>&amp;</span><span class=n>feat_blob</span><span class=p>,</span> <span class=kt>float</span> <span class=n>prob_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=o>&amp;</span><span class=n>objects</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>num_grid_x</span> <span class=o>=</span> <span class=n>feat_blob</span><span class=p>.</span><span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>num_grid_y</span> <span class=o>=</span> <span class=n>feat_blob</span><span class=p>.</span><span class=n>h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>num_anchors</span> <span class=o>=</span> <span class=n>anchors</span><span class=p>.</span><span class=n>w</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>num_class</span> <span class=o>=</span> <span class=n>feat_blob</span><span class=p>.</span><span class=n>c</span> <span class=o>/</span> <span class=n>num_anchors</span> <span class=o>-</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>feat_offset</span> <span class=o>=</span> <span class=n>num_class</span> <span class=o>+</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 遍历各个锚框，一般每个尺寸的特征图对应三个锚框
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>q</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>q</span> <span class=o>&lt;</span> <span class=n>num_anchors</span><span class=p>;</span> <span class=n>q</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>float</span> <span class=n>anchor_w</span> <span class=o>=</span> <span class=n>anchors</span><span class=p>[</span><span class=n>q</span> <span class=o>*</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>float</span> <span class=n>anchor_h</span> <span class=o>=</span> <span class=n>anchors</span><span class=p>[</span><span class=n>q</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析特征图得到推理结果，这部分代码可以参考 yolov7 的 Detect 层代码实现
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>num_grid_y</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>num_grid_x</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 寻找 score 最大的 class，这部分不属于 Detect 层
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kt>int</span> <span class=n>class_index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kt>float</span> <span class=n>class_score</span> <span class=o>=</span> <span class=o>-</span><span class=n>FLT_MAX</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>num_class</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>score</span> <span class=o>=</span> <span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>5</span> <span class=o>+</span> <span class=n>k</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>score</span> <span class=o>&gt;</span> <span class=n>class_score</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>class_index</span> <span class=o>=</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>class_score</span> <span class=o>=</span> <span class=n>score</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>float</span> <span class=n>box_score</span> <span class=o>=</span> <span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>4</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>float</span> <span class=n>confidence</span> <span class=o>=</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>box_score</span><span class=p>)</span> <span class=o>*</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>class_score</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>confidence</span> <span class=o>&gt;=</span> <span class=n>prob_threshold</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 参考 yolov7/models/yolo.py Detect forward
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// y = x[i].sigmoid()
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// y[..., 0:2] = (y[..., 0:2] * 2. - 0.5 + self.grid[i].to(x[i].device)) * self.stride[i]  # xy
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// y[..., 2:4] = (y[..., 2:4] * 2) ** 2 * self.anchor_grid[i]  # wh
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>dx</span> <span class=o>=</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>0</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>dy</span> <span class=o>=</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>1</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>dw</span> <span class=o>=</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>2</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>dh</span> <span class=o>=</span> <span class=n>sigmoid</span><span class=p>(</span><span class=n>feat_blob</span><span class=p>.</span><span class=n>channel</span><span class=p>(</span><span class=n>q</span> <span class=o>*</span> <span class=n>feat_offset</span> <span class=o>+</span> <span class=mi>3</span><span class=p>).</span><span class=n>row</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>pb_cx</span> <span class=o>=</span> <span class=p>(</span><span class=n>dx</span> <span class=o>*</span> <span class=mf>2.f</span> <span class=o>-</span> <span class=mf>0.5f</span> <span class=o>+</span> <span class=n>j</span><span class=p>)</span> <span class=o>*</span> <span class=n>stride</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>pb_cy</span> <span class=o>=</span> <span class=p>(</span><span class=n>dy</span> <span class=o>*</span> <span class=mf>2.f</span> <span class=o>-</span> <span class=mf>0.5f</span> <span class=o>+</span> <span class=n>i</span><span class=p>)</span> <span class=o>*</span> <span class=n>stride</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>pb_w</span> <span class=o>=</span> <span class=n>pow</span><span class=p>(</span><span class=n>dw</span> <span class=o>*</span> <span class=mf>2.f</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=n>anchor_w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>pb_h</span> <span class=o>=</span> <span class=n>pow</span><span class=p>(</span><span class=n>dh</span> <span class=o>*</span> <span class=mf>2.f</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=n>anchor_h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>x0</span> <span class=o>=</span> <span class=n>pb_cx</span> <span class=o>-</span> <span class=n>pb_w</span> <span class=o>*</span> <span class=mf>0.5f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>y0</span> <span class=o>=</span> <span class=n>pb_cy</span> <span class=o>-</span> <span class=n>pb_h</span> <span class=o>*</span> <span class=mf>0.5f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>x1</span> <span class=o>=</span> <span class=n>pb_cx</span> <span class=o>+</span> <span class=n>pb_w</span> <span class=o>*</span> <span class=mf>0.5f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>y1</span> <span class=o>=</span> <span class=n>pb_cy</span> <span class=o>+</span> <span class=n>pb_h</span> <span class=o>*</span> <span class=mf>0.5f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>obj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>rect</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>rect</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>y0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>rect</span><span class=p>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>x1</span> <span class=o>-</span> <span class=n>x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>rect</span><span class=p>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>y1</span> <span class=o>-</span> <span class=n>y0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>label</span> <span class=o>=</span> <span class=n>class_index</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=p>.</span><span class=n>prob</span> <span class=o>=</span> <span class=n>confidence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>objects</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从模型中提取三种尺寸的特征图输出，经过后处理后得到推理结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>Yolo</span><span class=o>::</span><span class=n>detect</span><span class=p>(</span><span class=k>const</span> <span class=n>cv</span><span class=o>::</span><span class=n>Mat</span> <span class=o>&amp;</span><span class=n>rgb</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=o>&amp;</span><span class=n>objects</span><span class=p>,</span> <span class=kt>float</span> <span class=n>prob_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=kt>float</span> <span class=n>nms_threshold</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>img_w</span> <span class=o>=</span> <span class=n>rgb</span><span class=p>.</span><span class=n>cols</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>img_h</span> <span class=o>=</span> <span class=n>rgb</span><span class=p>.</span><span class=n>rows</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// letterbox pad to multiple of 32
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>w</span> <span class=o>=</span> <span class=n>img_w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>img_h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>scale</span> <span class=o>=</span> <span class=mf>1.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>w</span> <span class=o>&gt;</span> <span class=n>h</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scale</span> <span class=o>=</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=n>target_size</span> <span class=o>/</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span> <span class=o>=</span> <span class=n>target_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>h</span> <span class=o>*</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scale</span> <span class=o>=</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=n>target_size</span> <span class=o>/</span> <span class=n>h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>target_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>int</span> <span class=n>max_stride</span> <span class=o>=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>in</span> <span class=o>=</span> <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span><span class=o>::</span><span class=n>from_pixels_resize</span><span class=p>(</span><span class=n>rgb</span><span class=p>.</span><span class=n>data</span><span class=p>,</span> <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span><span class=o>::</span><span class=n>PIXEL_RGB</span><span class=p>,</span> <span class=n>img_w</span><span class=p>,</span> <span class=n>img_h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>h</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// pad to target_size rectangle
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>wpad</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span> <span class=o>+</span> <span class=n>max_stride</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>max_stride</span> <span class=o>*</span> <span class=n>max_stride</span> <span class=o>-</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>hpad</span> <span class=o>=</span> <span class=p>(</span><span class=n>h</span> <span class=o>+</span> <span class=n>max_stride</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>max_stride</span> <span class=o>*</span> <span class=n>max_stride</span> <span class=o>-</span> <span class=n>h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>in_pad</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ncnn</span><span class=o>::</span><span class=n>copy_make_border</span><span class=p>(</span><span class=n>in</span><span class=p>,</span> <span class=n>in_pad</span><span class=p>,</span> <span class=n>hpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>hpad</span> <span class=o>-</span> <span class=n>hpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>wpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>wpad</span> <span class=o>-</span> <span class=n>wpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>ncnn</span><span class=o>::</span><span class=n>BORDER_CONSTANT</span><span class=p>,</span> <span class=mf>114.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>in_pad</span><span class=p>.</span><span class=n>substract_mean_normalize</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>norm_vals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ncnn</span><span class=o>::</span><span class=n>Extractor</span> <span class=n>ex</span> <span class=o>=</span> <span class=n>yolo</span><span class=p>.</span><span class=n>create_extractor</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ex</span><span class=p>.</span><span class=n>input</span><span class=p>(</span><span class=s>&#34;in0&#34;</span><span class=p>,</span> <span class=n>in_pad</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>proposals</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// stride 8
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ex</span><span class=p>.</span><span class=n>extract</span><span class=p>(</span><span class=s>&#34;out0&#34;</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>anchors</span><span class=p>(</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>12.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>16.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>19.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mf>36.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mf>40.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mf>28.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>objects8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>generate_proposals</span><span class=p>(</span><span class=n>anchors</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=n>in_pad</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>prob_threshold</span><span class=p>,</span> <span class=n>objects8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>proposals</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>proposals</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span> <span class=n>objects8</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>objects8</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// stride 16
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ex</span><span class=p>.</span><span class=n>extract</span><span class=p>(</span><span class=s>&#34;out1&#34;</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>anchors</span><span class=p>(</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>36.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>75.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>76.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mf>55.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mf>72.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mf>146.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>objects16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>generate_proposals</span><span class=p>(</span><span class=n>anchors</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=n>in_pad</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>prob_threshold</span><span class=p>,</span> <span class=n>objects16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>proposals</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>proposals</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span> <span class=n>objects16</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>objects16</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// stride 32
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ex</span><span class=p>.</span><span class=n>extract</span><span class=p>(</span><span class=s>&#34;out2&#34;</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ncnn</span><span class=o>::</span><span class=n>Mat</span> <span class=n>anchors</span><span class=p>(</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>142.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>110.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>192.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mf>243.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mf>459.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>anchors</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mf>401.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>objects32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>generate_proposals</span><span class=p>(</span><span class=n>anchors</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=n>in_pad</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>prob_threshold</span><span class=p>,</span> <span class=n>objects32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>proposals</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>proposals</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span> <span class=n>objects32</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>objects32</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// sort all proposals by score from highest to lowest
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qsort_descent_inplace</span><span class=p>(</span><span class=n>proposals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// apply nms with nms_threshold
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>picked</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nms_sorted_bboxes</span><span class=p>(</span><span class=n>proposals</span><span class=p>,</span> <span class=n>picked</span><span class=p>,</span> <span class=n>nms_threshold</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>picked</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>objects</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>proposals</span><span class=p>[</span><span class=n>picked</span><span class=p>[</span><span class=n>i</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// adjust offset to original unpadded
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>float</span> <span class=n>x0</span> <span class=o>=</span> <span class=p>(</span><span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=p>(</span><span class=n>wpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>))</span> <span class=o>/</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>y0</span> <span class=o>=</span> <span class=p>(</span><span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=p>(</span><span class=n>hpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>))</span> <span class=o>/</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>x1</span> <span class=o>=</span> <span class=p>(</span><span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>x</span> <span class=o>+</span> <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>width</span> <span class=o>-</span> <span class=p>(</span><span class=n>wpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>))</span> <span class=o>/</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>y1</span> <span class=o>=</span> <span class=p>(</span><span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>y</span> <span class=o>+</span> <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>height</span> <span class=o>-</span> <span class=p>(</span><span class=n>hpad</span> <span class=o>/</span> <span class=mi>2</span><span class=p>))</span> <span class=o>/</span> <span class=n>scale</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// clip
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>x0</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>x0</span><span class=p>,</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=p>(</span><span class=n>img_w</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)),</span> <span class=mf>0.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>y0</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>y0</span><span class=p>,</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=p>(</span><span class=n>img_h</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)),</span> <span class=mf>0.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>x1</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=p>(</span><span class=n>img_w</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)),</span> <span class=mf>0.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>y1</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>y1</span><span class=p>,</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=p>(</span><span class=n>img_h</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)),</span> <span class=mf>0.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>y0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>x1</span> <span class=o>-</span> <span class=n>x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>objects</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>rect</span><span class=p>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>y1</span> <span class=o>-</span> <span class=n>y0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=part4-2-1-匹配模型输出端>part4-2-1: 匹配模型输出端<a hidden class=anchor aria-hidden=true href=#part4-2-1-匹配模型输出端>#</a></h4><p>extract 的第一个入参要注意与实际模型的输出端名称匹配。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ex</span><span class=p>.</span><span class=n>extract</span><span class=p>(</span><span class=s>&#34;out0&#34;</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span></code></pre></div><p>可以以文本方式打开使用 pnnx 转换后得到的 <code>yolov7_tiny.pnnx.param</code>，查看输出端的名称。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Op                     # Name                   # Attr
</span></span><span class=line><span class=cl>pnnx.Output              out0                     1 0 135 #135=(1,3,80,80,85)f32
</span></span><span class=line><span class=cl>pnnx.Output              out1                     1 0 138 #138=(1,3,40,40,85)f32
</span></span><span class=line><span class=cl>pnnx.Output              out2                     1 0 141 #141=(1,3,20,20,85)f32
</span></span></code></pre></div><h3 id=part4-3-加载-param-和-bin>part4-3: 加载 .param 和 .bin<a hidden class=anchor aria-hidden=true href=#part4-3-加载-param-和-bin>#</a></h3><p>ncnn 模型文件分为网络结构文件<code>.param</code>和权重参数<code>.bin</code>，放到工程目录下的 app/src/main
/assets 中，加载代码部分在 app/src/main/jni/yolo.cpp 的 Yolo::load 函数。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yusjade.github.io/>YusJade 的个人博客 </a></span><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/sherlcok314159/MyPaperMod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("/js/pangu.min.js",function(){pangu.spacingPage()})</script><script>(function(){var e,t,n,s=document.getElementsByTagName("code");for(n=0;n<s.length;){if(t=s[n],t.parentNode.tagName!=="PRE"&&t.childElementCount===0&&(e=t.textContent,/^\$[^$]/.test(e)&&/[^$]\$$/.test(e)&&(e=e.replace(/^\$/,"\\(").replace(/\$$/,"\\)"),t.textContent=e),/^\\\((.|\s)+\\\)$/.test(e)||/^\\\[(.|\s)+\\\]$/.test(e)||/^\$(.|\s)+\$$/.test(e)||/^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(e))){t.outerHTML=t.innerHTML;continue}n++}})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>